angular.module("threequbes",["ui.bootstrap","ui.utils","ui.calendar"]),angular.module("threequbes").directive("appointmentModal",[function(){var a=["$scope","$modalInstance","$timeout","model","appointmentSvc","validation","threequbesUserService",function(a,b,c,d,e,f,g){if(a.optionValues={},a.siteSettings=e.getCustomerSettings(),d.appointment){if(a.model=d.appointment,a.model.startDate=new Date(a.model.startDate),a.model.options)for(var h=0;h<a.model.options.length;++h)a.optionValues[a.model.options[h].optionId]=a.model.options[h].value}else d.id?a.model=e.getAppointment(d.id):(a.model=e.newAppointment(),a.model.startDate=new Date,a.model.startDate.setHours(8,15),a.currentUser=g.getCurrentUser(),a.$watch("currentUser",function(){a.model.contactName=a.currentUser.fullName,a.model.contactEmail=a.currentUser.email},!0),a.model.contactName=a.currentUser.fullName,a.model.contactEmail=a.currentUser.email);a.allowOverride=d.allowOverride;var i=function(b){for(var c=0;c<a.availableAppointmentTypes.items.length;++c)if(a.availableAppointmentTypes.items[c].Id===b){a.availableOptions=a.availableAppointmentTypes.items[c].Options,a.model.typeName=a.availableAppointmentTypes.items[c].name;break}for(a.optionValidation.clear(),c=0;c<a.availableOptions.length;++c)a.optionValidation.add("optionValues["+a.availableOptions[c].Id+"]",a.availableOptions[c].name,f.required)};a.validation=f.create(a),a.validation.add("model.typeId","serviceType",f.required),a.validation.add("model.startDate","selectedDate",f.required),a.validation.add("model.contactName","contactName",f.required),a.validation.add("model.contactEmail","contactEmail",f.required),a.optionValidation=f.create(a),a.availableAppointmentTypes=e.getAvailableApptTypes(),a.availableAppointmentTypes.addOnReady(function(){a.model&&a.model.typeId&&i(a.model.typeId)}),a.$watch("model.typeId",function(b){a.availableOptions=[],b&&i(b)}),a.modalFormState={datePickerOpened:!1,minDate:new Date,dateOptions:{formatYear:"yyyy",startingDay:1},dateDisabled:function(a,b){return!1},openDatePicker:function(){c(function(){a.modalFormState.datePickerOpened=!a.modalFormState.datePickerOpened})}},a.ok=function(){if(a.validation.check()&&a.optionValidation.check()){for(var c in a.optionValues){a.model.options||(a.model.options=[]);for(var d=!1,e=0;e<a.model.options.length;++e)if(a.model.options[e].optionId===c){d=!0,a.model.options[e].value=a.optionValues[c];break}d||a.model.options.push({value:a.optionValues[c],optionId:c})}a.model.save("appointment").then(function(c){a.hasError=!1,b.close(a.model)},function(b){417===b.status&&(a.errorMessage=b.data.message,a.hasError=!0)})}},a.close=function(){b.dismiss("cancel")}}],b=["$scope","$modal",function(b,c){b.$watch(b.show,function(d){if(d){var e=c.open({animation:!0,templateUrl:"editAppointment.html",controller:a,size:"lg",resolve:{model:function(){return{id:b.appointmentId,appointment:b.appointment,allowOverride:b.allowOverride}}}});e.result.then(function(a){b.onSave()(a),b.show=!1},function(){b.onCancel()(),b.show=!1})}})}];return{restrict:"E",replace:!0,scope:{show:"&",appointmentId:"=",appointment:"=",onSave:"&",onCancel:"&",allowOverride:"@"},templateUrl:"threequbes/directive/appointmentModal/appointmentModal.html",controller:b}}]),angular.module("threequbes").directive("showBusy",["EventBus",function(a){var b=function(a){var b=a.currentTarget,c=$(b).attr("id"),d="loading_"+c,e=$("#"+d),f=$(b).offset();e.css({position:"absolute",marginLeft:0,marginTop:0,top:f.top,left:f.left}),e.width($(b).outerWidth()),e.height($(b).outerHeight()),$(b).is(":visible")?e.show():e.hide()};return{restrict:"A",link:function(c,d,e,f){var g=e.showBusy+"_start",h=e.showBusy+"_end",i=a.register(g,function(a){var c=$(d).attr("id")||Math.random().toString(16).slice(2,10);$(d).attr("id",c),$(d).resize(b);var e="loading_"+c;if(0===$("#"+e).length){var f=$("<div id='"+e+"'><div class='loading-overlay'><span class='glyphicon glyphicon-refresh spinning'></span></div></div>"),g=$(d).offset();f.css({position:"absolute",marginLeft:0,marginTop:0,top:g.top,left:g.left,"z-index":1e4}),f.width($(d).outerWidth()),f.height($(d).outerHeight()),$(d).is(":visible")?f.show():f.hide(),$("body").append(f)}}),j=function(){var a=$(d).attr("id"),c="loading_"+a;$("#"+c).length>0&&$("#"+c).remove(),$(d).unbind("resize",b)},k=a.register(h,function(a){j()});c.$on("$destroy",function(){j(),i(),k()})}}}]),angular.module("threequbes").directive("threequbesCalendar",function(){var a=["$scope","appointmentSvc",function(a,b){a.siteSettings=b.getCustomerSettings(),a.errorMessage="",a.hasError=!1;var c=function(a){return{id:a.Id,title:a.typeName,start:new Date(a.startDate),end:new Date(a.endDate),allDay:!1,editable:!1,durationEditable:!1}};a.events=[];var d=b.getAppointments();d.addOnReady(function(){for(var b=0;b<d.length;++b)a.events.push(c(d.items[b]))}),a.saveAppointment=function(b){a.appointmentEditorVisible=!1;for(var d=-1,e=0;e<a.events.length;e++)if(a.events[e].id===b.Id){d=e;break}d>=0&&a.events.splice(d,1),a.events.push(c(b)),a.appts.items.push(b)},a.cancelAppointmentEdit=function(){a.appointmentEditorVisible=!1},a.eventSources=[a.events],a.uiconfig={calendar:{editable:!0,weekMode:"liquid",url:"#",header:{left:"today",center:"prev, title, next",right:"agendaDay,agendaWeek,month"}}}}];return{restrict:"E",replace:!0,scope:{},templateUrl:"threequbes/directive/threequbesCalendar/threequbesCalendar.html",controller:a}}),angular.module("threequbes").directive("validationStatus",["$compile","$parse",function(a,b){function c(c,d,e){var f=c.$watch(e.validationStatus+".valid",function(a){if(a)d.attr("title",""),d.removeClass("has-error has-feedback");else{d.addClass("has-error has-feedback");var f=b(e.validationStatus+".errors[0]");d.attr("title",f(c))}}),g=c.$watch(e.validationStatus+".errors",function(a){var f=b(e.validationStatus+".errors[0]");d.attr("title",f(c))},!0),h=angular.element('<span class="fa fa-times form-control-feedback" ng-if="!'+e.validationStatus+'.valid"></span>');a(h)(c),d.append(h),c.$on("$destroy",function(){f(),g()})}return{link:c}}]),angular.module("threequbes").provider("ShowBusyHandler",function(){this.$get=["$q","$injector","$window","EventBus",function(a,b,c,d){var e={};return e.request=function(a){return a.hasOwnProperty("dataAnnotation")&&d.send(a.dataAnnotation+"_start",{}),a},e.response=function(b){return b.config&&b.config.hasOwnProperty("dataAnnotation")&&d.send(b.config.dataAnnotation+"_end",{}),b||a.when(b)},e.requestError=function(a){return a.config&&a.config.hasOwnProperty("dataAnnotation")&&d.send(a.config.dataAnnotation+"_end",{}),a},e.responseError=function(b){return b.config&&b.config.hasOwnProperty("dataAnnotation")&&d.send(b.config.dataAnnotation+"_end",{}),a.reject(b)},e}]}).config(["$httpProvider",function(a){a.interceptors.push("ShowBusyHandler")}]),angular.module("threequbes").factory("threequbesUserService",["resourceFactory","$http","$q","$window","$location","threequbesConfig",function(a,b,c,d,e,f){var g={},h=a.get("account","id"),i=null;g.getCurrentUser=function(){if(!i){var a=h.get("current");return a.addOnReady(function(){i=a}),a}return i},g.getAll=function(){return h.getAll()};var j=function(a,b,c){a[b]?c():e.path("/401")};return g.accessCheck=function(a,b){var c=g.getCurrentUser();c.loaded?j(c,a,b):c.addOnReady(function(){j(c,a,b)})},g.register=function(a){var d=c.defer(),e=f.serviceUrl+"/api/account/create";return b({method:"POST",url:e,dataAnnotation:"register",data:a}).success(function(a){d.resolve()}).error(function(a){a.modelState?d.reject(a.modelState.error[0]):d.reject(a.exceptionMessage)}),d.promise},g.changePassword=function(a,d){var e=c.defer(),g=f.serviceUrl+"/api/changePassword";return b({method:"POST",url:g+"?currentPass="+encodeURIComponent(a)+"&newPass="+encodeURIComponent(d),dataAnnotation:"user"}).success(function(a){e.resolve()}).error(function(a){a.modelState?e.reject(a.modelState.error[0]):e.reject(a.exceptionMessage)}),e.promise},g.updateProfile=function(a){var d=c.defer(),e=f.serviceUrl+"/api/account/update";return b({method:"POST",url:e,dataAnnotation:"user",data:{FirstName:a.firstName,LastName:a.lastName,Email:a.email,PhoneNumber:a.phoneNumber}}).success(function(a){d.resolve()}).error(function(a){a.modelState?d.reject(a.modelState.error[0]):d.reject(a.exceptionMessage)}),d.promise},g.login=function(a,e){var g=c.defer(),h=f.serviceUrl+"/oauth/token",i="grant_type=password&username="+a+"&password="+e+"&client_id=client_id";return b({method:"POST",url:h,data:i,dataAnnotation:"login",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){d.localStorage.threequbesAuthorizationData=JSON.stringify({token:b.access_token,userName:a}),g.resolve()}).error(function(a){g.reject(a.error_description)}),g.promise},g}]),angular.module("threequbes").factory("appointmentSvc",["resourceFactory",function(a){var b={},c=a.get("AppointmentTypes","Id"),d=a.get("appointments","Id"),e=a.get("ClientSettings","Id");return b.getAvailableApptTypes=function(){return c.getAll("appointment")},b.getApptType=function(a){return c.get(a,"appointment")},b.newAppointmentType=function(){return c["new"]()},b.newAppointment=function(){return d["new"]()},b.getAppointments=function(){return d.getAll("appointment")},b.getAppointment=function(a){return d.get(a,"appointment")},b.getCustomerSettings=function(){return e.getOne("appointment")},b}]),angular.module("threequbes").config(["$httpProvider",function(a){a.interceptors.push(["$q","$window","$injector",function(a,b,c){return{request:function(a){var c=JSON.parse(b.localStorage.threequbesAuthorizationData||"{}");return c&&c.hasOwnProperty("token")&&(a.headers.Authorization="Bearer "+c.token),a},responseError:function(b){return 401===b.status&&c.invoke(["$state",function(a){var b=a.current.name;"login"!==b&&"selectClient"!==b&&a.go("login",{returnState:b})}]),a.reject(b)}}}])}]),angular.module("threequbes").config(["$httpProvider",function(a){a.interceptors.push(["$q","threequbesConfig",function(a,b){return{request:function(a){return a.headers["X-BizCalendarClientId"]=b.clientId,a},responseError:function(b){return a.reject(b)}}}])}]),angular.module("threequbes").factory("clientService",["$http","$q","resourceFactory","threequbesConfig",function(a,b,c,d){var e=c.get("client","id"),f={};return f.getAll=function(){return e.getAll()},f.getClientList=function(){var c=b.defer(),e=d.serviceUrl+"/api/client/list";return a({method:"GET",url:e,dataAnnotation:"selectClient"}).success(function(a){c.resolve(a)}).error(function(a){a.modelState?c.reject(a.modelState.error[0]):c.reject(a.exceptionMessage)}),c.promise},f.newClient=function(){return e["new"]()},f}]),angular.module("threequbes").factory("EventBus",["$rootScope",function(a){var b={};return b.register=function(b,c){return a.$on(b,function(a,b){c(b)})},b.send=function(b,c){a.$emit(b,c)},b}]),angular.module("threequbes").factory("resourceFactory",["$http","$injector",function(a,b){var c={},d=function(a){var b={};return angular.extend(b,c),a&&(b.dataAnnotation=a),b},e={},f=function(){this.items=[],this.length=this.items.length,this.$$_readyCallbacks=[]};f.prototype.addOnReady=function(a){this.$$_readyCallbacks.push(a)},f.prototype.ready=function(){for(var a=0;a<this.$$_readyCallbacks.length;++a)this.$$_readyCallbacks[a]()},f.prototype.push=function(a){this.items.push(a),this.length=this.items.length},f.prototype.get=function(a){return this.items[a]},f.prototype["delete"]=function(){for(var a=0;a<this.items.length;++a)this.items[a]["delete"]();this.items=[],this.length=0},f.prototype.forEach=function(a){if(this.items.forEach)this.items.forEach(a);else for(var b in this.items)a(b,this.items[b],this.items)};var g=function(a,b,c){angular.extend(this,c),this.$$url=a,this.$$idProperty=b,this.$$_readyCallbacks=[],this.loaded=!1};g.prototype.addOnReady=function(a){this.$$_readyCallbacks.push(a)},g.prototype.ready=function(){this.loaded=!0;for(var a=0;a<this.$$_readyCallbacks.length;++a)this.$$_readyCallbacks[a]()},g.prototype.save=function(b){var c=this,e=d(b);if(this.hasOwnProperty(this.$$idProperty)&&this[this.$$idProperty]){var f=this[this.$$idProperty],g=a.post(this.$$url+"/"+f,this,e);return g.success(function(a){angular.extend(c,a)}),g}var h=a.post(this.$$url,this,e);return h.success(function(a){return angular.extend(c,a),c}),h},g.prototype.refresh=function(b){var c=this,e=d(b),f=c[c.$$idProperty],g=a.get(c.$$url+"/"+f,e);return g.success(function(a){angular.extend(c,a),c.ready()}),g},g.prototype["delete"]=function(b){var c=d(b);if(this.hasOwnProperty(this.$$idProperty)&&this[this.$$idProperty]){var e=this[this.$$idProperty];return a["delete"](this.$$url+"/"+e,this,c).then(function(a){return null})}return{success:function(a){a(null)},error:function(a){a(null)}}};var h=function(a,b){angular.extend(this),this.url=a,this.idProperty=b};return h.prototype.getOne=function(b){var c=d(b),e=new g(this.url,this.idProperty,{});return a.get(this.url,c).success(function(a,b,c,d){angular.isArray(a)?angular.extend(e,a[0]):angular.extend(e,a),e.ready()}),e},h.prototype.getAll=function(b){var c=new f,e=d(b),h=this;return a.get(this.url,e).then(function(a){if(angular.isArray(a.data))for(var b=0;b<a.data.length;++b)c.push(new g(h.url,h.idProperty,a.data[b]));else c.push(new g(h.url,h.idProperty,a.data));c.ready()}),c},h.prototype.get=function(b,c){var e=d(c),f=new g(this.url,this.idProperty,{});return a.get(this.url+"/"+b,e).success(function(a,b,c,d){angular.isArray(a)?angular.extend(f,a[0]):angular.extend(f,a),f.ready()}),f},h.prototype["new"]=function(a){return new g(this.url,this.idProperty,a)},e.get=function(a,c,d){return b.invoke(["threequbesConfig",function(b){var e=new h(b.serviceUrl+"/api/"+a,c);return d&&angular.extend(e,d),e}])},e.defaultConfig=c,e}]),angular.module("threequbes").provider("threequbesConfig",function(){var a={serviceUrl:"http://bizcalendar.azurewebsites.net/",clientId:"",apiKey:"",setClientId:function(a){this.clientId=a},setServiceUrl:function(a){this.serviceUrl=a},setAPIKey:function(a){this.apiKey=a}};this.serviceUrl=function(b){a.serviceUrl=b},this.apiKey=function(b){a.apiKey=b},this.clientId=function(b){a.clientId=b},this.$get=[function(){return a}]});var Validation=function(a,b,c,d,e){this._parser=a,this._scope=b,this.valid=!0,this.errors=[],this.shouldCheck=!1,this.validator=e,this.context=c,this.$$validation=!0,this._varToWatch=d;var f=this;this.$$varWatch=this._scope.$watch(d,function(a){f.shouldCheck&&f.validate(a)},!0)};Validation.prototype.check=function(){this.shouldCheck=!0;var a=this._parser(this._varToWatch),b=a(this._scope);this.validate(b)},Validation.prototype.unregister=function(){this.$$varWatch()},Validation.prototype.validate=function(a){var b=this.validator(a);this.valid=b.valid,this.errors=b.errors,this.context._updateState()};var ValidationContext=function(a,b){this._scope=a,this._parser=b,this.isValid=!0};ValidationContext.prototype.check=function(){for(var a in this)this[a].$$validation&&this[a].check();return this._updateState(),this.isValid},ValidationContext.prototype.clear=function(){for(var a in this)this[a].$$validation&&(this[a].unregister(),delete this[a]);this._updateState()},ValidationContext.prototype.add=function(a,b,c){var d=new Validation(this._parser,this._scope,this,a,c);this[b]=d,this._updateState()},ValidationContext.prototype._updateState=function(){var a=!0;for(var b in this)this[b].hasOwnProperty("$$validation")&&(a=a&&this[b].valid);this.isValid=a},angular.module("threequbes").factory("validation",["$parse",function(a){var b={};return b.create=function(b){var c=new ValidationContext(b,a);return c},b.required=function(a){var b={valid:void 0!==a&&null!=a&&a.toString().length>0,errors:[]};return b.valid||b.errors.push("This field is required"),b},b}]),angular.module("threequbes").run(["$templateCache",function(a){a.put("threequbes/directive/appointmentModal/appointmentModal.html",'<script type=text/ng-template id=editAppointment.html><div show-busy="appointment">\n        <div class="modal-header">\n            <button type="button" class="close" ng-click="close()" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n            <h4 class="modal-title" id="exampleModalLabel">New Appointment</h4>\n        </div>\n\n        <div class="modal-body">\n            <div class="bs-callout bs-callout-warning" ng-show="siteSettings.showAppointmentWarning">{{siteSettings.appointmentWarning}}</div>\n\n            <div class="bs-callout bs-callout-danger" ng-show="hasError">\n                <h4>Could not create appointment</h4>\n                <p>{{errorMessage}}</p>\n            </div>\n            <form class="form-horizontal">\n                <div class="form-group" validation-status="validation.serviceType">\n                    <label for="serviceType" class="col-lg-3">Service Type:</label>\n                    <div class="col-lg-9">\n                        <select id="serviceType" class="form-control col-lg-9"\n                                ng-required="true"\n                                ng-model="model.typeId"\n                                ng-options="option.Id as option.name for option in availableAppointmentTypes.items | filter :{active: true}">\n                            <option value="" ng-if="false"></option>\n                        </select>\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="apptDate" class="col-lg-3" validation-status="validation.selectedDate">Appointment Date:</label>\n                    <div class="col-lg-9">\n                        <div class="input-group">\n                            <input id="apptDate" type="date" class="form-control"\n                                   datepicker-popup\n                                   ng-model="model.startDate"\n                                   is-open="modalFormState.datePickerOpened"\n                                   min-date="modalFormState.minDate"\n                                   max-date="\'2020-06-22\'"\n                                   datepicker-options="modalFormState.dateOptions"\n                                   date-disabled="modalFormState.disabled(date, mode)"\n                                   ng-required="true"\n                                   close-text="Close" />\n                            <span class="input-group-btn">\n                                <button type="button" class="btn btn-default" ng-click="modalFormState.openDatePicker()"><i class="glyphicon glyphicon-calendar"></i></button>\n                            </span>\n                        </div>\n\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="apptTime" class="col-lg-3">Appointment Time:</label>\n                    <div class="col-lg-9">\n                        <timepicker id="apptTime" minute-step="15" show-spinners="false"\n                                    ng-required="true"\n                                    ng-model="model.startDate"></timepicker>\n\n                    </div>\n                </div>\n                <div ng-repeat="option in availableOptions| filter :{active: true}" class="form-group" validation-status="optionValidation[option.name]">\n                    <label for="{{\'option_\' + $index}}" class="col-lg-3">{{option.name}}:</label>\n                    <div class="col-lg-9">\n                        <input id="{{\'option_\' + $index}}" type="text" ng-required="true"\n                               class="form-control"\n                               ng-model="optionValues[option.Id]" />\n                    </div>\n                </div>\n                <div class="form-group" validation-status="validation.contactName">\n                    <label for="contactName" class="col-lg-3">Contact Name:</label>\n                    <div class="col-lg-9">\n                        <input id="contactName" type="text" ng-required="true"\n                               class="form-control"\n                               ng-model="model.contactName" />\n                    </div>\n                </div>\n\n                <div class="form-group" validation-status="validation.contactEmail">\n                    <label for="contactEmail" class="col-lg-3">Contact Email:</label>\n                    <div class="col-lg-9">\n                        <input id="contactEmail" type="text" ng-required="true"\n                               class="form-control"\n                               ng-model="model.contactEmail" />\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="contactPhone" class="col-lg-3">Contact Phone:</label>\n                    <div class="col-lg-9">\n                        <input id="contactPhone" type="text" ng-required="true"\n                               class="form-control"\n                               ng-model="model.contactPhone" />\n                    </div>\n                </div>\n\n\n\n                <div class="form-group">\n                    <label for="notes" class="col-lg-3">Notes:</label>\n                </div>\n                <div class="form-group">\n                    <div class="col-lg-12">\n                        <textarea class="form-control" id="notes" ng-model="model.notes"></textarea>\n                    </div>\n                </div>\n            </form>\n        </div>\n        <div class="modal-footer">\n            <div class="form-group" ng-show="allowOverride == \'true\'">\n                <div class="checkbox">\n                    <label><input type="checkbox" ng-required="true" ng-model="model.isOverride">Ignore scheduling rules</label>\n                </div>\n            </div>\n            <button type="button" class="btn btn-default" ng-click="close()">Close</button>\n            <button type="button" class="btn btn-primary"\n                    ng-disabled="!validation.isValid || !optionValidation.isValid"\n                    ng-click="ok()">\n                Save Appointment\n            </button>\n        </div>\n    </div></script>'),a.put("threequbes/directive/threequbesCalendar/threequbesCalendar.html",'<div class=well-lg show-busy=appointment><div class="bs-callout bs-callout-warning" ng-show=siteSettings.showDisclaimer>{{siteSettings.disclaimerLabel}}</div><label ng-show=sitesettings.showDisclaimer>JK</label><br><br><button type=button class="btn btn-primary" ng-click="appointmentEditorVisible = true">CREATE AN APPOINTMENT</button><br><br><div ui-calendar=uiconfig.calendar ng-model=eventSources></div><appointment-modal show=appointmentEditorVisible on-save=saveAppointment on-cancel=cancelAppointmentEdit allow-override=false></appointment-modal></div>')}]);